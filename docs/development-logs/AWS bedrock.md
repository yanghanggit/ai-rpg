# AWS Bedrock 配置指南

## IAM用户创建和权限配置

### 为什么要使用IAM用户而不是Root账号？

使用IAM用户是AWS的最佳安全实践，原因如下：

- **最小权限原则**：只授予必要的权限
- **审计和监控**：更好地跟踪操作记录
- **安全性**：降低Root账号泄露的风险
- **团队协作**：便于为不同的人员分配不同的权限

### 步骤1：登录AWS控制台

1. 使用你的Root账号登录 [AWS管理控制台](https://console.aws.amazon.com/)
2. 在搜索框中输入"IAM"并点击进入IAM服务

### 步骤2：创建IAM用户

1. 在IAM控制台左侧菜单中，点击 **"Users"（用户）**
2. 点击 **"Create user"（创建用户）**按钮
3. 填写用户详细信息：
   - **User name（用户名）**：建议使用有意义的名称，如 `game-developer-main`
   - 勾选 **"Provide user access to the AWS Management Console"**（为用户提供AWS管理控制台访问权限）
   - **Console password（控制台密码）**：选择 "Autogenerated password"（自动生成密码）或 "Custom password"（自定义密码）
   - 建议勾选 **"Users must create a new password at next sign-in"**（用户下次登录时必须创建新密码）

### 步骤3：分配权限

有两种方式分配权限，推荐使用**策略组**的方式：

#### 方式1：直接附加策略（推荐用于开始）

1. 在 **"Set permissions"** 页面，选择 **"Attach policies directly"**
2. 搜索并选择以下AWS托管策略：
   - **AmazonEC2FullAccess**：EC2完全访问权限
   - **AmazonBedrockFullAccess**：Bedrock完全访问权限
   - **IAMReadOnlyAccess**：IAM只读权限（用于查看自己的权限）

#### 方式2：创建用户组（推荐用于长期使用）

1. 先创建用户组：
   - 在IAM控制台点击 **"User groups"**
   - 点击 **"Create group"**
   - 组名：`developers`
   - 附加相同的策略：`AmazonEC2FullAccess`, `AmazonBedrockFullAccess`, `IAMReadOnlyAccess`
2. 将用户添加到组中

### 步骤4：完成创建

1. 审查所有设置
2. 点击 **"Create user"**
3. **重要**：保存登录信息
   - 控制台登录链接
   - 用户名
   - 临时密码（如果是自动生成的）

### 步骤5：配置多因素认证（MFA）- 强烈推荐

1. 创建用户后，点击用户名进入用户详情页
2. 点击 **"Security credentials"** 标签
3. 在 **"Multi-factor authentication (MFA)"** 部分点击 **"Assign MFA device"**
4. 选择 **"Authenticator app"**（推荐使用Google Authenticator或Microsoft Authenticator）
5. 按照指引完成MFA设置

### 步骤6：测试IAM用户登录

1. 退出Root账号
2. 使用IAM用户的登录链接登录（格式通常是：`https://your-account-id.signin.aws.amazon.com/console`）
3. 输入IAM用户名和密码
4. 如果设置了MFA，输入验证码
5. 测试访问EC2和Bedrock服务

## 权限说明

### 当前分配的权限

- **AmazonEC2FullAccess**：
  - 启动、停止、终止EC2实例
  - 创建和管理安全组、密钥对
  - 管理EBS卷和快照
  - 查看所有EC2资源

- **AmazonBedrockFullAccess**：
  - 访问所有Bedrock模型
  - 创建和管理模型训练作业
  - 管理Bedrock资源

- **IAMReadOnlyAccess**：
  - 查看IAM用户、组和策略
  - 不能修改IAM资源（安全考虑）

### 后续权限优化建议

随着你对AWS服务的熟悉，建议：

1. **使用更细粒度的权限**：
   - 替换FullAccess策略为更具体的权限
   - 只授予实际需要的操作权限

2. **创建自定义策略**：

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "ec2:DescribeInstances",
           "ec2:StartInstances",
           "ec2:StopInstances"
         ],
         "Resource": "*"
       }
     ]
   }
   ```

3. **使用资源级权限**：
   - 限制只能操作特定的资源
   - 使用标签进行权限控制

## 安全最佳实践

1. **定期轮换密码**
2. **启用CloudTrail**：记录所有API调用
3. **使用最小权限原则**
4. **定期审查权限**
5. **不要在代码中硬编码访问密钥**

## 常见问题

### Q: 忘记IAM用户密码怎么办？

A: 使用Root账号登录，在IAM控制台重置IAM用户密码。

### Q: 如何获取程序化访问权限（Access Key）？

A: 在IAM用户的"Security credentials"标签下创建Access Key，用于CLI和SDK访问。

### Q: 权限不足错误怎么解决？

A: 检查用户或组的策略，确保包含所需的权限。可以使用IAM Policy Simulator测试权限。

### Q: 创建Access Key时提示权限不足怎么办？

A: 使用Root账号登录，在IAM控制台中直接为IAM用户创建Access Key。进入Users → 选择用户 → Security credentials → Create access key。

## AWS Bedrock 使用指南

### 步骤1：启用Bedrock模型访问权限

在使用Bedrock之前，需要先启用你想要使用的模型：

1. **登录AWS控制台**（使用IAM用户）
2. **搜索"Bedrock"**并进入Amazon Bedrock服务
3. **在左侧菜单中点击"Model access"**
4. **点击"Manage model access"按钮**
5. **选择你需要的模型**：
   - **推荐开始模型**：
     - `Claude 3 Haiku`（Anthropic）- 轻量级，适合简单任务
     - `Claude 3 Sonnet`（Anthropic）- 平衡性能和成本
     - `Titan Text G1 - Lite`（Amazon）- AWS自有模型
6. **点击"Request model access"**
7. **等待审批**（通常几分钟内完成）

### 步骤2：配置AWS凭据

有几种方式配置AWS凭据：

#### 方式1：使用AWS CLI配置（推荐）

1. **安装AWS CLI**：

   ```bash
   # macOS
   brew install awscli
   
   # 或者使用pip
   pip install awscli
   ```

2. **配置凭据**：

   ```bash
   aws configure
   ```

   输入：
   - AWS Access Key ID: `你的Access Key ID`
   - AWS Secret Access Key: `你的Secret Access Key`
   - Default region name: `us-east-1`（Bedrock主要支持区域）
   - Default output format: `json`

#### 方式2：环境变量

```bash
export AWS_ACCESS_KEY_ID=你的Access_Key_ID
export AWS_SECRET_ACCESS_KEY=你的Secret_Access_Key
export AWS_DEFAULT_REGION=us-east-1
```

#### 方式3：在代码中配置（不推荐生产环境）

```python
import boto3

client = boto3.client(
    'bedrock-runtime',
    aws_access_key_id='你的Access_Key_ID',
    aws_secret_access_key='你的Secret_Access_Key',
    region_name='us-east-1'
)
```

### 步骤3：安装必要的Python库

```bash
pip install boto3
pip install anthropic  # 如果使用Claude模型
```

### 步骤4：编写第一个Bedrock应用

#### 使用Claude模型示例

```python
import boto3
import json

# 创建Bedrock客户端
bedrock_runtime = boto3.client(
    'bedrock-runtime',
    region_name='us-east-1'
)

def call_claude_3_haiku(prompt):
    """调用Claude 3 Haiku模型"""
    
    # 构建请求体
    body = json.dumps({
        "anthropic_version": "bedrock-2023-05-31",
        "max_tokens": 1000,
        "messages": [
            {
                "role": "user",
                "content": prompt
            }
        ]
    })
    
    try:
        # 调用模型
        response = bedrock_runtime.invoke_model(
            modelId='anthropic.claude-3-haiku-20240307-v1:0',
            contentType='application/json',
            accept='application/json',
            body=body
        )
        
        # 解析响应
        response_body = json.loads(response['body'].read())
        return response_body['content'][0]['text']
        
    except Exception as e:
        print(f"调用Bedrock时出错: {e}")
        return None

# 使用示例
if __name__ == "__main__":
    prompt = "你好，请简单介绍一下Python编程语言。"
    result = call_claude_3_haiku(prompt)
    print(f"AI回复: {result}")
```

#### 使用Amazon Titan模型示例

```python
import boto3
import json

def call_titan_text(prompt):
    """调用Amazon Titan Text模型"""
    
    bedrock_runtime = boto3.client(
        'bedrock-runtime',
        region_name='us-east-1'
    )
    
    body = json.dumps({
        "inputText": prompt,
        "textGenerationConfig": {
            "maxTokenCount": 1000,
            "stopSequences": [],
            "temperature": 0.7,
            "topP": 0.9
        }
    })
    
    try:
        response = bedrock_runtime.invoke_model(
            modelId='amazon.titan-text-lite-v1',
            contentType='application/json',
            accept='application/json',
            body=body
        )
        
        response_body = json.loads(response['body'].read())
        return response_body['results'][0]['outputText']
        
    except Exception as e:
        print(f"调用Bedrock时出错: {e}")
        return None

# 使用示例
result = call_titan_text("解释什么是机器学习")
print(f"AI回复: {result}")
```

### 步骤5：集成到你的游戏框架

根据你的多智能体游戏框架，可以这样集成：

```python
# 在你的游戏框架中添加AI服务
class BedrockAIService:
    def __init__(self):
        self.bedrock_runtime = boto3.client(
            'bedrock-runtime',
            region_name='us-east-1'
        )
    
    def generate_npc_dialogue(self, context, character_name):
        """为NPC生成对话"""
        prompt = f"""
        你是游戏中的角色{character_name}。
        当前情况：{context}
        请生成一段符合角色设定的对话，不超过50字。
        """
        return self.call_claude(prompt)
    
    def generate_quest_description(self, quest_type, difficulty):
        """生成任务描述"""
        prompt = f"""
        创建一个{quest_type}类型的游戏任务，难度为{difficulty}。
        请提供任务名称、描述和目标。
        """
        return self.call_claude(prompt)
    
    def call_claude(self, prompt):
        # 使用之前的Claude调用代码
        pass
```

### 重要注意事项

1. **成本控制**：
   - Bedrock按使用量计费
   - 设置CloudWatch告警监控成本
   - 合理设置max_tokens限制

2. **区域选择**：
   - Bedrock主要在 `us-east-1` 和 `us-west-2` 可用
   - 检查模型在你选择的区域是否可用

3. **速率限制**：
   - 注意API调用频率限制
   - 实现重试机制

4. **安全性**：
   - 不要在代码中硬编码密钥
   - 使用IAM角色（如果在EC2上运行）
   - 定期轮换Access Key

### 调试和监控

1. **启用CloudTrail**：跟踪API调用
2. **使用CloudWatch**：监控使用量和性能
3. **检查模型访问状态**：确保模型已启用

现在你可以开始使用Bedrock了！建议先从简单的文本生成开始测试。
