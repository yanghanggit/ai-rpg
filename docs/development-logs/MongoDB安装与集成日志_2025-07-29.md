# MongoDB å®‰è£…ä¸é›†æˆæ—¥å¿—

**æ—¥æœŸ**: 2025å¹´7æœˆ29æ—¥  
**ä½œè€…**: yanghanggit  
**é¡¹ç›®**: multi-agents-game-framework  
**åˆ†æ”¯**: roguelike_tcg_base  

## ğŸ“‹ å¯¹è¯æ¦‚è¦

æœ¬æ¬¡å¯¹è¯ä¸»è¦å›´ç»• MongoDB çš„ç†è§£ã€å®‰è£…å’Œåœ¨æ¸¸æˆé¡¹ç›®ä¸­çš„åº”ç”¨å±•å¼€ï¼ŒåŒ…æ‹¬æŠ€æœ¯é€‰å‹åˆ†æã€å®é™…å®‰è£…è¿‡ç¨‹å’ŒåŠŸèƒ½éªŒè¯ã€‚

## ğŸ¯ ä¸»è¦ç›®æ ‡

1. **ç†è§£ MongoDB**: äº†è§£ MongoDB çš„æ ¸å¿ƒç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯
2. **æŠ€æœ¯é€‰å‹**: åˆ†æ MongoDB æ˜¯å¦é€‚åˆå­˜å‚¨æ¸¸æˆ World ç±»æ•°æ®
3. **ç¯å¢ƒå®‰è£…**: åœ¨ macOS (Apple Silicon) ä¸Šå®‰è£… MongoDB
4. **åŠŸèƒ½éªŒè¯**: æµ‹è¯• MongoDB çš„åŸºæœ¬åŠŸèƒ½å’Œæ€§èƒ½

## ğŸ” æŠ€æœ¯åˆ†æ

### MongoDB æ ¸å¿ƒç‰¹ç‚¹

- **æ–‡æ¡£æ•°æ®åº“**: ä½¿ç”¨ BSON (Binary JSON) å­˜å‚¨æ•°æ®
- **çµæ´»æ¨¡å¼**: æ— å›ºå®š schemaï¼Œæ”¯æŒåŠ¨æ€å­—æ®µ
- **æ°´å¹³æ‰©å±•**: åŸç”Ÿæ”¯æŒåˆ†ç‰‡ (Sharding)
- **é«˜å¯ç”¨æ€§**: å‰¯æœ¬é›† (Replica Sets) æ”¯æŒ
- **å¼ºå¤§æŸ¥è¯¢**: æ”¯æŒå¤æ‚æŸ¥è¯¢å’Œèšåˆç®¡é“

### é€‚ç”¨æ€§åˆ†æ

é’ˆå¯¹é¡¹ç›®ä¸­çš„ World ç±»ï¼ŒMongoDB å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- å¤©ç„¶æ”¯æŒåµŒå¥—çš„ JSON ç»“æ„
- æ— éœ€é¢„å®šä¹‰å¤æ‚çš„å…³ç³»è¡¨ç»“æ„
- æ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼Œé¿å…æ•´æ–‡æ¡£æ›¿æ¢
- å¯ä»¥å¯¹ä»»æ„å­—æ®µå»ºç«‹ç´¢å¼•

éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š

- å•æ–‡æ¡£å¤§å°é™åˆ¶ 16MB
- é¢‘ç¹å†™å…¥éœ€è¦è€ƒè™‘æ€§èƒ½ä¼˜åŒ–
- éœ€è¦åˆç†è®¾è®¡æ•°æ®åˆ†ç¦»ç­–ç•¥

## ğŸ–¥ï¸ è®¾å¤‡ç¯å¢ƒ

```text
æ“ä½œç³»ç»Ÿ: Darwin 24.5.0 (macOS)
CPUæ¶æ„: arm64 (Apple Silicon)
å¤„ç†å™¨: ARM (16 ç‰©ç†æ ¸å¿ƒ, 16 é€»è¾‘æ ¸å¿ƒ)
å†…å­˜æ€»é‡: 48.0 GB
å†…å­˜å¯ç”¨: 19.6 GB
ç£ç›˜æ€»å®¹é‡: 926.4 GB
ç£ç›˜å¯ç”¨ç©ºé—´: 268.7 GB
```

## ğŸ› ï¸ å®‰è£…è¿‡ç¨‹

### ç¯å¢ƒæ£€æŸ¥

- âœ… Homebrew 4.5.8 å·²å®‰è£…
- âœ… Python ç¯å¢ƒ (conda first_seed) å·²é…ç½®

### MongoDB å®‰è£…æ­¥éª¤

```bash
# 1. æ·»åŠ  MongoDB å®˜æ–¹ tap
brew tap mongodb/brew

# 2. å®‰è£… MongoDB Community Edition
brew install mongodb-community

# 3. å¯åŠ¨ MongoDB æœåŠ¡
brew services start mongodb/brew/mongodb-community

# 4. å®‰è£… Python é©±åŠ¨
conda run --live-stream --name first_seed pip install pymongo
```

### å®‰è£…ç»“æœ

å·²å®‰è£…ç»„ä»¶ï¼š

- MongoDB Community Edition 8.0.12
- MongoDB Shell (mongosh) 2.5.6  
- MongoDB Database Tools 100.12.2
- Python pymongo é©±åŠ¨

æœåŠ¡é…ç½®ï¼š

- ç›‘å¬åœ°å€: 127.0.0.1:27017
- é…ç½®æ–‡ä»¶: /opt/homebrew/etc/mongod.conf
- æ•°æ®ç›®å½•: /opt/homebrew/var/mongodb
- æ—¥å¿—æ–‡ä»¶: /opt/homebrew/var/log/mongodb/mongo.log

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† scripts/test_mongodb.py æµ‹è¯•è„šæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **è¿æ¥æµ‹è¯•**: éªŒè¯ MongoDB æœåŠ¡è¿æ¥
2. **æ•°æ®å­˜å‚¨**: æ¨¡æ‹Ÿ World å¯¹è±¡å­˜å‚¨
3. **å¢é‡æ›´æ–°**: æµ‹è¯•éƒ¨åˆ†å­—æ®µæ›´æ–°
4. **æŸ¥è¯¢æ€§èƒ½**: æµ‹è¯•ç´¢å¼•å’ŒæŸ¥è¯¢é€Ÿåº¦
5. **æ•°æ®æ¸…ç†**: æ¸…é™¤æµ‹è¯•æ•°æ®

### æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•å‡é€šè¿‡ï¼š

- MongoDB è¿æ¥æˆåŠŸ
- World æ•°æ®æ’å…¥æˆåŠŸï¼Œæ–‡æ¡£å¤§å° 0.001 MB
- å¢é‡æ›´æ–°æˆåŠŸ
- æŸ¥è¯¢æ€§èƒ½è‰¯å¥½ï¼Œå¹³å‡ 2.50 msï¼ˆå¸¦ç´¢å¼•ï¼‰

## ğŸ’¡ é›†æˆå»ºè®®

### æ•°æ®åº“è®¾è®¡

å»ºè®®çš„é›†åˆç»“æ„ï¼š

```text
ai_rpg/
â”œâ”€â”€ worlds          # å®Œæ•´æ¸¸æˆä¸–ç•ŒçŠ¶æ€
â”œâ”€â”€ players         # ç©å®¶ä¿¡æ¯
â”œâ”€â”€ game_sessions   # æ¸¸æˆä¼šè¯ä¿¡æ¯
â””â”€â”€ chat_logs       # èŠå¤©è®°å½•ï¼ˆå¯é€‰åˆ†ç¦»ï¼‰
```

### SaveSystem é›†æˆç¤ºä¾‹

```python
import pymongo
from datetime import datetime

class SaveSystem(ExecuteProcessor):
    def __init__(self, game_context: TCGGame) -> None:
        self._game: TCGGame = game_context
        self._client = pymongo.MongoClient("mongodb://localhost:27017/")
        self._db = self._client['tcg_game']
        self._worlds_collection = self._db['worlds']

    def execute(self) -> None:
        world_data = {
            "game_id": self._game.game_id,
            "runtime_index": self._game.world.runtime_index,
            "timestamp": datetime.now(),
            "world_data": self._game.world.model_dump(),
            "version": self._game.world.version
        }
        
        self._worlds_collection.insert_one(world_data)
        logger.info(f"æ¸¸æˆçŠ¶æ€å·²ä¿å­˜åˆ° MongoDB: {world_data['game_id']}")
```

### å­˜å‚¨ç­–ç•¥

#### æ–¹æ¡ˆ1: ç‰ˆæœ¬åŒ–å­˜å‚¨

- æ¯ä¸ªæ¸¸æˆçŠ¶æ€ä½œä¸ºç‹¬ç«‹æ–‡æ¡£
- é€‚åˆéœ€è¦å®Œæ•´å†å²è®°å½•çš„åœºæ™¯

#### æ–¹æ¡ˆ2: å¢é‡å­˜å‚¨

- åªå­˜å‚¨å˜åŒ–çš„éƒ¨åˆ†
- èŠ‚çœå­˜å‚¨ç©ºé—´

#### æ–¹æ¡ˆ3: åˆ†ç¦»å­˜å‚¨

- å°†å¤§å‹æ•°æ®åˆ†ç¦»åˆ°ä¸åŒé›†åˆ
- é¿å…å•æ–‡æ¡£è¿‡å¤§

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

```bash
# æœåŠ¡ç®¡ç†
brew services start mongodb/brew/mongodb-community    # å¯åŠ¨
brew services stop mongodb/brew/mongodb-community     # åœæ­¢  
brew services restart mongodb/brew/mongodb-community  # é‡å¯

# è¿æ¥å’Œæ“ä½œ
mongosh                                               # è¿æ¥ Shell
mongosh --eval "db.version()"                        # æ£€æŸ¥ç‰ˆæœ¬

# æ—¥å¿—æŸ¥çœ‹
tail -f /opt/homebrew/var/log/mongodb/mongo.log       # å®æ—¶æ—¥å¿—
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

åŸºäºæµ‹è¯•ç»“æœï¼š

- è¿æ¥æ—¶é—´: < 100ms
- æ’å…¥æ“ä½œ: < 10ms
- æŸ¥è¯¢æ“ä½œ: ~2.5ms (å¸¦ç´¢å¼•)
- æ–‡æ¡£å¤§å°: æµ‹è¯•æ•°æ® ~0.001MB

## ğŸ æ€»ç»“

æœ¬æ¬¡ MongoDB å®‰è£…å’Œé›†æˆéå¸¸æˆåŠŸï¼š

å·²å®Œæˆï¼š

- MongoDB å®Œæ•´å®‰è£…å’Œé…ç½®
- åŸºæœ¬åŠŸèƒ½éªŒè¯é€šè¿‡
- æ€§èƒ½æµ‹è¯•è¾¾åˆ°é¢„æœŸ
- é›†æˆæ–¹æ¡ˆè®¾è®¡å®Œæˆ

æŠ€æœ¯æ”¶è·ï¼š

- æ·±å…¥ç†è§£äº† MongoDB çš„ç‰¹ç‚¹å’Œä¼˜åŠ¿
- æŒæ¡äº† macOS ä¸Šçš„å®‰è£…å’Œé…ç½®æµç¨‹
- éªŒè¯äº†ä¸æ¸¸æˆé¡¹ç›®çš„æŠ€æœ¯é€‚é…æ€§
- åˆ¶å®šäº†å®Œæ•´çš„é›†æˆæ–¹æ¡ˆ

ä¸‹ä¸€æ­¥ï¼š

- åœ¨å®é™…é¡¹ç›®ä¸­é›†æˆ MongoDB
- å®æ–½æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢é€»è¾‘
- è¿›è¡Œå‹åŠ›æµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–

MongoDB å®Œå…¨ç¬¦åˆé¡¹ç›®éœ€æ±‚ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ”¯æŒå¤æ‚çš„æ¸¸æˆçŠ¶æ€å­˜å‚¨å’Œå¿«é€Ÿçš„è¯»å†™æ“ä½œã€‚
